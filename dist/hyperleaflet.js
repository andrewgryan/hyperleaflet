!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("leaflet")):"function"==typeof define&&define.amd?define(["leaflet"],t):(e||self).hyperleaflet=t(e.leaflet)}(this,function(e){var t={OpenStreetMap:e.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}),EsriWorldImagery:e.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"})};function r(e,t){var r=e.getBounds(),n=r.getSouthWest(),o=r.getNorthEast(),a=r.toBBoxString();return new CustomEvent(t,{detail:{zoom:e.getZoom(),center:e.getCenter(),bbox:{min:n,max:o},bboxString:a}})}function n(r){var n,o,a,i=r.dataset,s=i.tile,u=i.tileUrl,l=i.minZoom,d=i.maxZoom;if(u){var c=new e.TileLayer(u,{minZoom:(a=void 0===(o={minZoom:l,maxZoom:d,tms:"true"===i.tms})?{}:o).minZoom||0,maxZoom:a.maxZoom||18,tms:!!a.tms});t[(n={name:s,tile:c}).name]?console.warn("Tile layer "+n.name+" already exists. Skipping."):t[n.name]=n.tile}var p=t[s];return p?(p.options.minZoom=l,p.options.maxZoom=d,{tile:p,name:s}):(console.warn(s+" is not in: \n"+Object.keys(t).join("\n")),null)}function o(e,t){void 0===t&&(t=!1);try{var r=JSON.parse(e);return t?function(e){return e.reverse()}(r):r}catch(e){return[0,0]}}var a={reverseOrderAll:!1};function i(e){e.removeAttribute("data-geometry")}function s(){return s=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s.apply(this,arguments)}function u(e,t){e.on("click",function(r){var n=new CustomEvent("geometry:click",{detail:{clickedPoint:r.latlng,geometry:e.getLatLngs(),rowId:t}});window.dispatchEvent(n)})}var l=["dataset"],d={events:{},observe:function(e){var t=e.targetSelector,r=e.uniqueAttribute,n=e.attributeFilter;if(this.events[t])throw new Error("Can't observer twice");!function(e,t,r){var n=new MutationObserver(function(n){var i,u,l=performance.now(),c=[],p=[];n.forEach(function(r){if("childList"===r.type)c.push.apply(c,a(r.removedNodes)),p.push.apply(p,a(r.addedNodes));else if("attributes"===r.type){var n,o=r.attributeName,i=((n={attribute:o,from:r.oldValue,to:r.target.getAttribute(o)})[t]=r.target.getAttribute(t),n),s=[{node:r.target,changes:i}];s.length&&d.publish(e,"node_changes",s)}});var v=[],f=new Map(c.map(function(e){return[e.getAttribute(t),e]})),m=new Set;p.forEach(function(e){var n=e.getAttribute(t),a=f.get(n);if(a&&m.add(n),a&&!o(a,e,r)){var i=r.reduce(function(r,o){var i,s=a.getAttribute(o),u=e.getAttribute(o);return s!==u&&r.push(((i={attribute:o,from:s,to:u})[t]=n,i)),r},[]);v.push(s({},i,{dataset:e.dataset}))}});var g=null!=(i=c.filter(function(e){return!m.has(e.getAttribute(t))}))?i:[],b=null!=(u=p.filter(function(e){return!m.has(e.getAttribute(t))}))?u:[];b.length&&d.publish(e,"node_adds",b),v.length&&d.publish(e,"node_changes",v),g.length&&d.publish(e,"node_removes",g);var y=performance.now();console.log(" "+(y-l)+" milliseconds.")}),o=function(e,t,r){return r.every(function(r){return e.getAttribute(r)===t.getAttribute(r)})};function a(e){var r=[];return e.forEach(function(e){1===e.nodeType&&(e.hasAttribute(t)&&r.push(e),r.push.apply(r,a(null==e?void 0:e.childNodes)))}),r}var i={childList:!0,subtree:!0,attributes:!0,attributeFilter:r,attributeOldValue:!0},u=document.querySelector(e);n.observe(u,i)}(t,r,n),this.events[t]={}},subscribe:function(e,t,r){this.events[e][t]=this.events[e][t]||[],this.events[e][t].push(r)},unsubscribe:function(e,t,r){this.events[e][t]&&(this.events[e][t]=this.events[e][t].filter(function(e){return e!==r}))},publish:function(e,t,r){this.events[e][t]&&this.events[e][t].forEach(function(e){e(r)})}};window.pubsub=d;var c,p,v,f="[data-hyperleaflet-source]";return c=function(){var c=!1;function p(){var p=document.querySelector("#map");if(p&&!c){c=!0,void 0!==p.dataset.reverseOrderAll&&(a.reverseOrderAll=!0);var v=function(t){var n,i=t.dataset,s=i.zoom,u=i.minZoom,l=i.maxZoom,d={center:o(i.center,a.reverseOrderAll),zoom:s||1},c=e.map(t,{center:d.center,zoom:d.zoom,minZoom:u||0,maxZoom:l||18});return(n=c).on("click",function(e){var t=new CustomEvent("map:click",{detail:{point:e.latlng}});window.dispatchEvent(t)}),n.whenReady(function(){var e=r(n,"map:load");window.dispatchEvent(e)}),n.on("zoomend",function(){var e=r(n,"map:zoom");window.dispatchEvent(e)}),n.on("move",function(){var e=r(n,"map:move");window.dispatchEvent(e)}),n.on("moveend",function(){var e=r(n,"map:moveend");window.dispatchEvent(e)}),n.on("movestart",function(){var e=r(n,"map:movestart");window.dispatchEvent(e)}),n}(p),m=function(r){var o,a=Array.from(r),i=a.map(n).filter(Boolean),s=function(e){var r=e.find(function(e){return"defaultTile"in e.dataset});return r&&r.dataset.tile in t?t[r.dataset.tile]:e.length&&e[0].dataset.tile in t?t[e[0].dataset.tile]:t.OpenStreetMap}(a);return{defaultHyperleafletTile:s,tileController:(o=i).length?e.control.layers(Object.fromEntries(o.map(function(e){return[e.name,e.tile]}))):null}}(p.querySelectorAll("[data-tile]")),g=m.defaultHyperleafletTile,b=m.tileController;b&&b.addTo(v),g.addTo(v),function(t){var r=document.querySelector(f);if(r){var n=r.dataset.geometryDisplay||"none",o={};if("json"===n){var c=function(){var e=document.createElement("script");e.type="application/json",e.setAttribute("data-testid","json"),e.innerText="{}",document.body.appendChild(e);var t=JSON.parse(e.text);return{addToGeometryObject:function(r){var n=r.dataset,o=n.id,a=n.geometry,i=n.geometryType;r.removeAttribute("data-geometry"),t[o]={type:i,coordinates:JSON.parse(a)},e.text=JSON.stringify(t,null,2)},removeFromGeometryObject:function(r){delete t[r.dataset.id],e.text=JSON.stringify(t,null,2)}}}();o={addCallback:c.addToGeometryObject,removeCallback:c.removeFromGeometryObject}}else"remove"===n&&(o={addCallback:i,removeCallback:function(){}});var p=function(t,r){var n=r.addCallback,o=void 0===n?function(){}:n,i=r.removeCallback,d=void 0===i?function(){}:i;return{addNoteListToHyperleaflet:function(r){r.forEach(function(r){!function(t,r){var n=t.dataset,o=n.id;if(Object.values(r._layers).find(function(e){return e.hlID===o}))console.error("%c"+o,"color:red","already exists",t);else{var i=function(t){if("l"in t)return function(e){if("imageoverlay"===e.l.toLowerCase()){[["imageUrl","data-image-url"],["imageBounds","data-image-bounds"]].forEach(function(t){if(void 0===e[t[0]])throw new Error("Required attribute "+t[1]+" for image overlay not specified in dataset.")});var t=void 0;return void 0!==e.imageOpacity&&(t={opacity:Number(e.imageOpacity)}),L.imageOverlay(e.imageUrl,JSON.parse(e.imageBounds),t)}throw new Error("data-l "+e.l+" not supported")}(t);var r=t.popup,n=t.tooltip,o=t.geometryType,i=t.id,s=t.reverseOrder,l=t.options,d=void 0===l?"{}":l,c=t.icon,p=JSON.parse(t.geometry),v=JSON.parse(d),f=a.reverseOrderAll;return function(t){return function(r,n){switch(t){case"Point":return function(t,r){var n,o,a,i=r.reverseOrderAll||void 0!==r.reverseOrder?[].concat(t).reverse():t;return n=r.icon?e.marker(i,{icon:e.icon(JSON.parse(r.icon))}):e.marker(i),r.popup&&n.bindPopup(r.popup),r.tooltip&&n.bindTooltip(r.tooltip),a=r.id,(o=n).on("click",function(e){var t=new CustomEvent("geometry:click",{detail:{clickedPoint:e.latlng,geometry:o.getLatLng(),rowId:a}});window.dispatchEvent(t)}),n}(r,n);case"LineString":return function(t,r){var n=r.options,o=r.reverseOrderAll||void 0!==r.reverseOrder?e.GeoJSON.coordsToLatLngs(t,0):t,a=e.polyline(o,n);return r.popup&&a.bindPopup(r.popup),r.tooltip&&a.bindTooltip(r.tooltip),u(a,r.id),a}(r,n);case"Polygon":return function(t,r){var n=r.options,o=r.reverseOrderAll||void 0!==r.reverseOrder?e.GeoJSON.coordsToLatLngs(t,1):t,a=e.polygon(o,n);return r.popup&&a.bindPopup(r.popup),r.tooltip&&a.bindTooltip(r.tooltip),u(a,r.id),a}(r,n);default:return console.warn(t+" is not supported"),null}}}(o)(p,{popup:r,tooltip:n,id:i,reverseOrderAll:f,reverseOrder:s,options:v,icon:c})}(s({},n));i.hlID=o,i.addTo(r)}}(r,t),o(r)})},removeNodeListFromHyperleaflet:function(e){e.forEach(function(e){!function(e,t){var r=e.dataset.id,n=Object.values(t._layers).find(function(e){return e.hlID===r});null==n||n.remove()}(e,t),d(e)})},changeNodesInHyperleaflet:function(r){r.forEach(function(r){var n=r.dataset,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(o[r]=e[r]);return o}(r,l);void 0!==n&&Object.values(o).forEach(function(r){!function(t,r){var n=t["data-id"];!function(t,r){switch(r.attribute.toLowerCase()){case"data-geometry":return function(t,r){var n=r.dataset.geometryType,o=JSON.parse(r.to),i=a.reverseOrderAll;switch(n){case"Point":return function(e,t,r){var n=r.reverseOrderAll||void 0!==r.reverseOrder?[].concat(t).reverse():t;return e.setLatLng(n),e}(t,o,s({},r.dataset,{reverseOrderAll:i}));case"LineString":return function(t,r,n){var o=n.reverseOrderAll||void 0!==n.reverseOrder?e.GeoJSON.coordsToLatLngs(r,0):r;return t.setLatLngs(o),t}(t,o,s({},r.dataset,{reverseOrderAll:i}));case"Polygon":return function(t,r,n){var o=n.reverseOrderAll||void 0!==n.reverseOrder?e.GeoJSON.coordsToLatLngs(r,1):r;return t.setLatLngs(o),t}(t,o,s({},r.dataset,{reverseOrderAll:i}));default:return console.warn(n+" is not supported"),null}}(t,r);case"data-options":return function(e,t){return e.setStyle(JSON.parse(t.to))}(t,r);case"data-l":case"data-image-url":case"data-image-bounds":case"data-image-opacity":return function(e,t){switch(t.attribute.toLowerCase()){case"data-image-bounds":return e.setBounds(JSON.parse(t.to));case"data-image-url":return e.setUrl(t.to);case"data-image-opacity":return e.setOpacity(Number(t.to));default:throw new Error("change to "+t.attribute+" not supported")}}(t,r);default:throw new Error("Unsupported attribute "+r.attribute+" in dataset for changing Leaflet object.")}}(Object.values(r._layers).find(function(e){return e.hlID===n}),t)}(s({},r,{dataset:n}),t)})})}}}(t,o),v=p.addNoteListToHyperleaflet,m=p.removeNodeListFromHyperleaflet,g=p.changeNodesInHyperleaflet;t.whenReady(function(){var e=r.querySelectorAll("[data-id]");v(e)}),d.observe({targetSelector:f,uniqueAttribute:"data-id",attributeFilter:["data-geometry","data-options","data-l","data-image-url","data-image-bounds","data-image-opacity"]}),d.subscribe(f,"node_adds",function(e){v(e)}),d.subscribe(f,"node_removes",function(e){m(e)}),d.subscribe(f,"node_changes",function(e){g(e)})}}(v),window.hyperleaflet={map:v},function(e){var t=r(e,"hyperleaflet:ready");window.dispatchEvent(t)}(v)}}return{initMap:p,observeMap:function(){new MutationObserver(function(){document.querySelector("#map")?p():c&&(c=!1,delete window.hyperleaflet)}).observe(document.documentElement,{childList:!0,subtree:!0})}}}(),p=c.initMap,v=c.observeMap,void document.addEventListener("DOMContentLoaded",function(){p(),v()})});
//# sourceMappingURL=hyperleaflet.js.map
